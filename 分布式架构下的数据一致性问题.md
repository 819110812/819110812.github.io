# 分布式架构下的数据一致性问题

## 序

在正文开始之前，想要简单的叙述下为什么写这篇文章。 分布式架构中的数据一致性问题不是一个新鲜的话题，在网上随便搜索一番都可以找到很多的通用解决方案，之所以写这篇文章，一是想要记录并总结一下这些方案之间的不同之处，以及适合使用的场景，二是想给到感兴趣的小伙伴一些关于在解决分数据一致性问题时的一些思路 （大佬们可以自行绕道）。 不多废话，开始我们的正题~

## 什么时候需要数据一致性

在微服务架构的背景之下，随着我们系统架构的不断演进，我们之前的一些原子操作会随着系统的拆分而变得更加难以维护，我们的某个操作需要同时协调多个系统来完成我们的请求，在这种需要涉及**多个系统或者多个组件同时处理一个问题**并且**系统产生的数据对我们存在一定价值**时，往往这个时候是需要考虑数据一致性的一个问题。举两个例子：



**场景一： 库存订单的场景（多个系统）**

一个经典的场景就是我们在网上下了一个订单之后，从业务上我们需要保证我们的下订单操作和扣减库存操作需要做到一致，确保不会因为下订单或者扣减库存操作单方面的成功而导致超卖或者少卖的现象。



**场景二：数据库和缓存  （多个组件）**

借用上面库存订单系统场景，我们如果将库存信息放到缓存中，假设当前库存是100件商品，客户端发起了数量为1的库存扣减操作后，库存数据库库存扣减成功，而缓存没有刷新时，当新的请求下单请求进来，我们查询缓存得到的库存此时仍然是100，而实际上库内只有99件时，一旦数量超过实际库存，则会导致库存不足而无法发货的情况。





## 我们有哪些方法去解决一致性问题

### 1. 业务角度来解决

在讲述技术解决方法之前，我们要思考一个问题，数据一致性问题的根本原因是什么？我们上面有提到两个场景，无论是场景一还是场景二，我认为他们本质问题其实都是在解决业务上的问题，我们需要**通过技术来实现业务上的准确性**。 因此，我们是否可以通过业务的改变来解决技术上的问题呢？

这方面最典型的代表就是我们熟知的双十一活动，相信大家还记得，在双十一刚开始的时候，所有流量都堆积到了双十一一天，大家都在凌晨的时候狂刷手机，要刷好久才能刷出页面来。在后来双十一就推出了预售活动，提前一些时间开始双十一的预售活动，顾客只需要在双十一当天付尾款即可完成订单。其实这个就是通过业务模式的一个改变，来解决双十一当天高并发的一个技术问题。同样的，我们也可以尝试改变我们的业务上的一些规则来解决数据一致性的问题。

(缺乏一个从业务角度解决数据一致性的问题)

### 2. 技术手段来解决

从技术的角度来说，当我们对一致性要求越高，对应的方案和方案的实现成本也是越高的。

1. 数据的强一致性

   所谓的数据强一致性就是要求我们系统内所有节点存的数据都是一致的，这种对于用户而言是最好的，存进系统的是什么，读出来的就是什么。我们可用**通过 基于`2PC`或者`3PC` 的分布式事务机制来达到一个数据的强一致性**，但是这些方案带来的缺点就是系统性能的损耗会很大，因为要保证强一致性需要知道系统内所有节点都反馈成功才行。一般而言，我们会要求组件与组件之间如数据库主从节点之间实现数据的强一致性。

2. 数据的弱一致性

   弱一致性就是我们系统无法保证我们每次读到的数据都是最近写入的一个数据，也不承诺我们系统多久后会达到一个一致性的状态，系统容忍我们读到的数据可以不是最新的。我们可以通过更新第一时间更新主节点信息，然后再后续将数据同步到副本节点的方式来实现数据的弱一致性。

3. 最终一致性

​	   在分布式系统理论中比较有名的另一个理论就是`**BASE理论**`，它提出既然我们无法达到系统更多强一致性，我们可以实现**系统数据的最终一致**， 在现实开	  发场景中我们更多选择的也是最终一致性的技术解决方案。最终一致性其实是弱一致性的一个特殊情况，它会保证系统在一段时间内达到一个数据一致的状	   态。 我们实现系统最终一致性的基本模式有：

- 异步重试模式

​		我们可以引入一个中间件来存储我们的操作，然后通过中间件来重试失败的操作以确保我们操作的最终一致性。比如有这么一个场景：我们下单后会收到一条		短信通知告知我们下单成功。在异步重试的模式下，我们在订单系统完成订单后发布一条消息到消息队列中，然后通过消息队列来进行下一步操作，这样可以		借助消息队列自身的重试机制来规避由于短信服务宕机或者出错带来的数据不一致问题。

![](https://golearning.oss-cn-shanghai.aliyuncs.com/obsidian20221007131743.png)

- 定时校对模式

  我们会有一个定时任务去定时抽取我们的不同系统的数据，然后进行校对，对不匹配的数据做一个数据上的补偿。 这种模式多用于金融系统中的对账系统来确保资金账目的一致性。

- 超时取消模式

​	   可以使用一个定时任务来保证一些业务在一段时间内如果没有成功执行就取消操作。如：我们下单后我们的订单状态会变成待支付状态，如果订单一段时间内 	   没有支付成功，我们就可以发起一个取消订单的补偿操作，这样系统中不会有很多的待支付的订单脏数据。



















###  方法之间的总结





## 总结

解决问题的原则是可以业务解决的事情就不要让技术来做，技术最终是服务于业务，如果能从源头上解决问题是最好的，我们在选择方案的时候应该去权衡实现和维护的成本和我们最终的收益比是否合理。