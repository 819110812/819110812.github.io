import{_ as n}from"./plugin-vue_export-helper.21dcd24c.js";import{o as s,c as a,e}from"./app.6df1d003.js";const t={},o=e(`<h1 id="golang\u5E76\u53D1\u7F16\u7A0B-sync\u5305" tabindex="-1"><a class="header-anchor" href="#golang\u5E76\u53D1\u7F16\u7A0B-sync\u5305" aria-hidden="true">#</a> golang\u5E76\u53D1\u7F16\u7A0B sync\u5305</h1><p><img src="https://golearning.oss-cn-shanghai.aliyuncs.com/obsidian20220910131423.png" alt="golang \u9501\u6A21\u578B" loading="lazy"></p><div style="text-align:center;">golang\u9501\u6A21\u578B</div><h2 id="mutex-\u548C-rwmutex" tabindex="-1"><a class="header-anchor" href="#mutex-\u548C-rwmutex" aria-hidden="true">#</a> mutex \u548C rwmutex</h2><h3 id="\u662F\u4EC0\u4E48" tabindex="-1"><a class="header-anchor" href="#\u662F\u4EC0\u4E48" aria-hidden="true">#</a> \u662F\u4EC0\u4E48\uFF1F</h3><p><code>Mutex</code>: \u548Cjava\u91CC\u7684\u4E00\u6837\uFF0C<code>Mutex</code>\u662F\u4E00\u4E2A\u4E92\u65A5\u9501\uFF0C\u4E5F\u5C31\u662F\u8BF4\uFF0C\u540C\u4E00\u65F6\u523B\u53EA\u80FD\u6709\u4E00\u4E2Agoroutine\u6301\u6709\u9501\uFF0C\u5176\u4ED6\u7684goroutine\u53EA\u80FD\u7B49\u5F85\u3002 <code>RWMutex</code>: \u8BFB\u5199\u9501\uFF0C <code>RWMutex</code>\u6709\u4E24\u4E2A\u9501\uFF0C\u4E00\u4E2A\u662F\u8BFB\u9501\uFF0C\u4E00\u4E2A\u662F\u5199\u9501\u3002\u8BFB\u9501\u662F\u5171\u4EAB\u7684\uFF0C\u591A\u4E2Agoroutine\u53EF\u4EE5\u540C\u65F6\u6301\u6709\u8BFB\u9501\uFF0C \u800C\u5199\u9501\u662F\u72EC\u5360\u7684\uFF0C\u53EA\u80FD\u6709\u4E00\u4E2Agoroutine\u6301\u6709\u5199\u9501\u3002\u5F53\u4E00\u4E2Agoroutine\u6301\u6709\u5199\u9501\u65F6\uFF0C\u5176\u4ED6goroutine\u65E2\u4E0D\u80FD\u6301\u6709\u8BFB\u9501\uFF0C\u4E5F\u4E0D\u80FD\u6301\u6709\u5199\u9501\u3002</p><h3 id="\u600E\u4E48\u7528" tabindex="-1"><a class="header-anchor" href="#\u600E\u4E48\u7528" aria-hidden="true">#</a> \u600E\u4E48\u7528\uFF1F</h3><p>\u4E00\u822C\u7684\u7528\u6CD5\u5C31\u662F\u5C06<code>Mutex</code>\u6216\u8005<code>RWMutex</code>\u548C\u9700\u8981\u4FDD\u62A4\u7684\u6570\u636E\u653E\u5728\u4E00\u8D77\uFF0C\u8FD9\u6837\u5C31\u53EF\u4EE5\u4FDD\u8BC1\u6570\u636E\u7684\u5B89\u5168\u6027\u4E86\u3002 \u5982\uFF1A</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">type</span> Counter <span class="token keyword">struct</span> <span class="token punctuation">{</span>
    lock sync<span class="token punctuation">.</span>Mutex
    count <span class="token builtin">int</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>Counter<span class="token punctuation">)</span> <span class="token function">Inc</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    c<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">defer</span> c<span class="token punctuation">.</span>lock<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    c<span class="token punctuation">.</span>count<span class="token operator">++</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>\u8FD9\u6837\u7684\u5199\u6CD5\u53EF\u4EE5\u4FDD\u8BC1\uFF0C\u522B\u4EBA\u5728\u8C03\u7528\u65B9\u6CD5\u65F6\uFF0C\u53EF\u4EE5\u4E0D\u7528\u518D\u624B\u52A8\u7684\u53BB\u8BBE\u7F6E\u9501\u4E86\uFF0C\u786E\u4FDD\u6211\u4EEC\u52A0\u9501\u7684\u4E00\u4E2A\u903B\u8F91\u4E0D\u4F1A\u6563\u843D\u5230\u5404\u4E2A\u5730\u65B9\u3002</p><p>\u6CE8\uFF1A\u4F7F\u7528\u9501\u7684\u65F6\u5019\u53EF\u4EE5\u4F18\u5148\u4F7F\u7528RWMutex</p><h3 id="rwmutex\u7684\u4F7F\u7528" tabindex="-1"><a class="header-anchor" href="#rwmutex\u7684\u4F7F\u7528" aria-hidden="true">#</a> RWmutex\u7684\u4F7F\u7528</h3><p>\u4E3B\u8981\u65B9\u6CD5\uFF1A RLock() RUnlock() Lock() Unlock()</p><h4 id="\u600E\u4E48\u7528-1" tabindex="-1"><a class="header-anchor" href="#\u600E\u4E48\u7528-1" aria-hidden="true">#</a> \u600E\u4E48\u7528\uFF1F</h4><p>\u5B9E\u6218\u6848\u4F8B\uFF1A <code>LoadOrStore</code>\u65B9\u6CD5</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">type</span> Map <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	mu sync<span class="token punctuation">.</span>RWMutex
	m  <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span><span class="token builtin">string</span>
<span class="token punctuation">}</span>

<span class="token comment">// LoadOrStore: \u5DF2\u6709key\u5219\u8FD4\u56DE\u5BF9\u5E94\u503C\uFF0Cloaded=true, \u53CD\u4E4B\u5219\u662F\u8FD4\u56DE\u65B0\u7684\u503C\uFF0Cloaded=false</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>m <span class="token operator">*</span>Map<span class="token punctuation">)</span> <span class="token function">LoadOrStore</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> newValue <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>value <span class="token builtin">string</span><span class="token punctuation">,</span> loaded <span class="token builtin">bool</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// \u52A0\u8BFB\u9501</span>
	m<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">RLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token comment">// \u5982\u679C\u8981\u6DFB\u52A0\u7684\u5185\u5BB9\u5DF2\u7ECF\u5B58\u5728\u4E86</span>
	oldValue<span class="token punctuation">,</span> ok <span class="token operator">:=</span> m<span class="token punctuation">.</span>m<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
	<span class="token comment">// \u4E00\u5B9A\u8981\u5728\u8FD9\u8FB9\u624B\u52A8\u91CA\u653E\u9501\uFF0C\u5982\u679C\u4F7F\u7528defer\u91CA\u653E\u9501\uFF0C\u4F1A\u5728\u4E0B\u65B9\u52A0\u9501\u65F6\u5F62\u6210\u6B7B\u9501</span>
	<span class="token comment">// \u56E0\u4E3Adefer\u662F\u5728\u8FD4\u56DE\u65F6\u8FD4\u56DE\u6267\u884C\u64CD\u4F5C</span>
	m<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">RUnlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> ok <span class="token punctuation">{</span>
		<span class="token keyword">return</span> oldValue<span class="token punctuation">,</span> ok
	<span class="token punctuation">}</span>
	<span class="token comment">// \u52A0\u5199\u9501</span>
	m<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">defer</span> m<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">Unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token comment">// double check</span>
	<span class="token comment">// \u5728\u8BBE\u503C\u524D\u9700\u8981double check\uFF0C\u786E\u4FDD\u4E0D\u4F1A\u56E0\u4E3A\u5176\u4ED6\u7684goroutine\u800C\u628A\u503C\u8986\u76D6</span>
	oldValue<span class="token punctuation">,</span> ok <span class="token operator">=</span> m<span class="token punctuation">.</span>m<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
	<span class="token keyword">if</span> ok <span class="token punctuation">{</span>
		<span class="token keyword">return</span> oldValue<span class="token punctuation">,</span> ok
	<span class="token punctuation">}</span>
	m<span class="token punctuation">.</span>m<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> newValue
	fmt<span class="token punctuation">.</span><span class="token function">Printf</span><span class="token punctuation">(</span><span class="token string">&quot;newValue is %s\\n&quot;</span><span class="token punctuation">,</span> newValue<span class="token punctuation">)</span>
	<span class="token keyword">return</span> newValue<span class="token punctuation">,</span> <span class="token boolean">false</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="once" tabindex="-1"><a class="header-anchor" href="#once" aria-hidden="true">#</a> once</h2><h3 id="\u662F\u4EC0\u4E48-1" tabindex="-1"><a class="header-anchor" href="#\u662F\u4EC0\u4E48-1" aria-hidden="true">#</a> \u662F\u4EC0\u4E48\uFF1F</h3><p><code>Once</code>\u662F\u4E00\u4E2A\u53EA\u6267\u884C\u4E00\u6B21\u7684\u7ED3\u6784\u4F53\uFF0C\u53EF\u4EE5\u7528\u6765\u4FDD\u8BC1\u67D0\u4E2A\u51FD\u6570\u53EA\u6267\u884C\u4E00\u6B21\uFF0C\u6BD4\u5982\u521D\u59CB\u5316\u7684\u65F6\u5019\uFF0C\u53EA\u9700\u8981\u521D\u59CB\u5316\u4E00\u6B21\u5C31\u53EF\u4EE5\u4E86\u3002 \u4F8B\u5B50\uFF1A</p><div class="language-go ext-go line-numbers-mode"><pre class="language-go"><code><span class="token keyword">var</span> instance <span class="token operator">*</span>singleton
<span class="token keyword">var</span> once sync<span class="token punctuation">.</span>Once

<span class="token comment">// GetInstance: \u83B7\u53D6\u5355\u4F8B \u65E0\u8BBA\u8C03\u7528\u591A\u5C11\u6B21GetInstance\uFF0C\u90FD\u53EA\u4F1A\u6267\u884C\u4E00\u6B21</span>
<span class="token keyword">func</span> <span class="token function">GetInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span>singleton <span class="token punctuation">{</span>
    once<span class="token punctuation">.</span><span class="token function">Do</span><span class="token punctuation">(</span><span class="token keyword">func</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        instance <span class="token operator">=</span> <span class="token operator">&amp;</span>singleton<span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> instance
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="pool" tabindex="-1"><a class="header-anchor" href="#pool" aria-hidden="true">#</a> pool</h2><h3 id="\u662F\u4EC0\u4E48-2" tabindex="-1"><a class="header-anchor" href="#\u662F\u4EC0\u4E48-2" aria-hidden="true">#</a> \u662F\u4EC0\u4E48\uFF1F</h3><p><code>Pool</code>\u662F\u4E00\u4E2A\u53EF\u4EE5\u5B89\u5168\u7684\u5728\u591A\u4E2Agoroutine\u95F4\u5171\u4EAB\u4E14\u91CD\u7528\u7684\u5BF9\u8C61\u7684\u96C6\u5408\uFF0C\u53EF\u4EE5\u7528\u6765\u51CF\u5C11\u5185\u5B58\u5206\u914D\u7684\u6B21\u6570\uFF0C\u63D0\u9AD8\u6027\u80FD\u3002\u4E00\u822C\u60C5\u51B5\u4E0B\uFF0C\u5982\u679C\u8003\u8651\u7F13\u5B58\u8D44\u6E90\uFF0C \u5982\u521B\u5EFA\u597D\u7684\u5BF9\u8C61\uFF0C\u53EF\u4EE5\u653E\u5230pool\u91CC\u9762\u3002\u4F46\u662F<code>sync.Pool</code>\u4E0D\u9002\u5408\u7528\u6765\u7BA1\u7406\u6240\u6709\u7684\u8D44\u6E90\uFF0C\u56E0\u4E3A\u5B83\u4E0D\u4F1A\u5BF9\u8D44\u6E90\u7684\u6570\u91CF\u8FDB\u884C\u9650\u5236\uFF0C\u5982\u679C\u8D44\u6E90\u6570\u91CF\u8FC7\u591A\uFF0C\u4F1A\u5BFC\u81F4\u5185\u5B58\u6EA2\u51FA\uFF0C \u5E76\u4E14GC\u7684\u65F6\u5019\u4F1A\u91CA\u653E\u8D44\u6E90\u3002</p><h3 id="\u600E\u4E48\u7528-2" tabindex="-1"><a class="header-anchor" href="#\u600E\u4E48\u7528-2" aria-hidden="true">#</a> \u600E\u4E48\u7528\uFF1F</h3><h2 id="waitgroup" tabindex="-1"><a class="header-anchor" href="#waitgroup" aria-hidden="true">#</a> waitgroup</h2><p><img src="https://golearning.oss-cn-shanghai.aliyuncs.com/obsidian\u626B\u7801_\u641C\u7D22\u8054\u5408\u4F20\u64AD\u6837\u5F0F-\u6807\u51C6\u8272\u7248.png" alt="" loading="lazy"></p>`,26),c=[o];function p(i,l){return s(),a("div",null,c)}var r=n(t,[["render",p],["__file","golang \u5E76\u53D1\u7F16\u7A0Bsync\u5305.html.vue"]]);export{r as default};
